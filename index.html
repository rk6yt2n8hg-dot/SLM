<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SLM-Control v3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        :root {
            --anthracite-dark: #0F1115;
            --anthracite-panel: #1A1D24;
            --anthracite-lighter: #2A2D35;
            --pink: #FF006E;
            --text-primary: #FFFFFF;
            --text-secondary: #B0B3B8;
            --blue: #00A8FF;
            --yellow: #FFD93D;
            --green: #00FF88;
            --red: #FF3B30;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--anthracite-dark);
            color: var(--text-primary);
            padding: 20px;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header .connection {
            display: inline-block;
            padding: 8px 20px;
            background: var(--anthracite-panel);
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .header .connection:hover {
            background: var(--pink);
        }
        
        .header .connection.disconnected {
            color: var(--text-secondary);
        }
        
        /* LED Status Leiste */
        .led-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .led-box {
            background: var(--anthracite-panel);
            border: 2px solid var(--pink);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .led-light {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .led-light::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .led-blue { background: var(--blue); }
        .led-yellow { background: var(--yellow); }
        .led-green { background: var(--green); }
        .led-red { background: var(--red); }
        
        .led-off {
            opacity: 0.3;
            filter: grayscale(100%);
        }
        
        .led-blink {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .led-info {
            flex: 1;
        }
        
        .led-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }
        
        .led-value {
            font-size: 1.1rem;
            font-weight: 700;
        }
        
        .led-value.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .led-value.clickable:hover {
            color: var(--pink);
            transform: scale(1.05);
        }
        
        /* Panels */
        .panels-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .panel {
            background: var(--anthracite-panel);
            border-radius: 12px;
            border: 2px solid var(--pink);
            padding: 25px;
            height: 500px;
            display: flex;
            flex-direction: column;
        }
        
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .panel-title {
            font-size: 1.3rem;
            font-weight: 700;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-box {
            background: var(--anthracite-lighter);
            border: 1px solid var(--pink);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .stat-value.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-value.clickable:hover {
            color: var(--pink);
            transform: scale(1.05);
        }
        
        .chart-container {
            flex: 1;
            position: relative;
            min-height: 0;
        }
        
        /* ACS712 Panel */
        .acs-panel {
            background: var(--anthracite-panel);
            border: 2px solid var(--pink);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .acs-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--pink);
            text-align: center;
            margin: 20px 0;
        }
        
        .acs-description {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* Fehlermeldungen */
        .error-panel {
            background: var(--anthracite-panel);
            border: 2px solid var(--pink);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .error-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .error-item {
            background: var(--anthracite-lighter);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid var(--pink);
        }
        
        .error-code {
            font-weight: 700;
            color: var(--pink);
            min-width: 60px;
        }
        
        .error-message {
            flex: 1;
            margin: 0 15px;
        }
        
        .error-time {
            color: var(--text-secondary);
            font-size: 0.85rem;
            min-width: 150px;
            text-align: right;
        }
        
        .error-delete {
            background: var(--anthracite-dark);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            margin-left: 10px;
        }
        
        .error-delete:hover {
            background: var(--pink);
            border-color: var(--pink);
        }
        
        .no-errors {
            text-align: center;
            color: var(--green);
            padding: 30px;
            font-size: 1.2rem;
        }
        
        /* Buttons */
        .reset-btn {
            background: var(--anthracite-dark);
            border: 1px solid var(--text-secondary);
            color: var(--text-primary);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'JetBrains Mono', monospace;
            margin-top: 10px;
        }
        
        .reset-btn:hover {
            background: var(--pink);
            border-color: var(--pink);
            transform: translateY(-2px);
        }
        
        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: var(--anthracite-panel);
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .modal-display {
            background: var(--anthracite-dark);
            padding: 20px;
            border-radius: 8px;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 20px;
            font-weight: 700;
            color: var(--pink);
        }
        
        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .numpad-btn {
            background: var(--anthracite-lighter);
            border: none;
            color: var(--text-primary);
            padding: 20px;
            border-radius: 8px;
            font-size: 1.3rem;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .numpad-btn:hover {
            background: var(--pink);
            transform: scale(1.05);
        }
        
        .numpad-btn.wide {
            grid-column: span 2;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .modal-btn.confirm {
            background: var(--pink);
            color: white;
        }
        
        .modal-btn.cancel {
            background: var(--anthracite-lighter);
            color: var(--text-primary);
        }
        
        .modal-btn:hover {
            transform: translateY(-2px);
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: var(--text-secondary);
        }
        
        .footer-name {
            color: var(--pink);
            font-weight: 700;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .panels-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .led-panel {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>SLM-Control System v3.0</h1>
            <div class="connection disconnected" id="connectionBtn" onclick="connectSerial()">
                <span id="connectionStatus">‚óè Nicht verbunden - Klicken zum Verbinden</span>
            </div>
        </div>
        
        <!-- LED Status -->
        <div class="led-panel">
            <div class="led-box">
                <div class="led-light led-blue led-off" id="led1"></div>
                <div class="led-info">
                    <div class="led-label">L√ºfter</div>
                    <div class="led-value" id="fan-status">AUS</div>
                </div>
            </div>
            
            <div class="led-box">
                <div class="led-light led-yellow led-off" id="led2"></div>
                <div class="led-info">
                    <div class="led-label">Filter Pr√ºfen</div>
                    <div class="led-value clickable" id="filter-countdown" onclick="openTimeEditor()">00:00:00</div>
                    <button class="reset-btn" onclick="resetFilter()">üîÑ Reset</button>
                </div>
            </div>
            
            <div class="led-box">
                <div class="led-light led-green led-off" id="led3"></div>
                <div class="led-info">
                    <div class="led-label">Temp-Status</div>
                    <div class="led-value" id="temp-status">OK</div>
                </div>
            </div>
            
            <div class="led-box">
                <div class="led-light led-red led-off" id="led4"></div>
                <div class="led-info">
                    <div class="led-label">L√ºfter Defekt</div>
                    <div class="led-value" id="defect-status">OK</div>
                    <button class="reset-btn" onclick="clearFanDefect()" id="clear-defect-btn" style="display: none;">üîÑ Reset Defekt</button>
                </div>
            </div>
        </div>
        
        <!-- ACS712 Sensor -->
        <div class="acs-panel">
            <div class="panel-header">
                <div class="panel-title">‚ö° ACS712 Stromsensor (5A)</div>
            </div>
            <div class="acs-value" id="acs-value">---</div>
            <div class="acs-description">
                Gemittelter Wert (64 Messungen) | L√ºfter TOT: <span class="clickable" style="color: var(--pink); cursor: pointer;" id="acs-dead" onclick="openAcsEditor()">520</span>
                <button class="reset-btn" onclick="resetAcsDead()" style="margin-left: 10px;">üîÑ Standard</button>
            </div>
            <div style="text-align: center; color: var(--text-secondary); font-size: 0.8rem; margin-top: 10px;">
                185mV/A @ 5A Version | Oversampling f√ºr h√∂here Stabilit√§t<br>
                ‚ö†Ô∏è Bei 150mA an Untergrenze - ACS712 30A oder INA219 empfohlen
            </div>
        </div>
        
        <!-- Temperatur & Luftfeuchtigkeit -->
        <div class="panels-grid">
            <!-- Temperatur -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üå°Ô∏è Temperatur</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Aktuell</div>
                        <div class="stat-value" id="current-temp">--¬∞C</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Wunsch</div>
                        <div class="stat-value clickable" id="target-temp" onclick="openTempEditor()">--¬∞C</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">√ò</div>
                        <div class="stat-value" id="avg-temp">--¬∞C</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Min</div>
                        <div class="stat-value" id="min-temp">--¬∞C</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>
            
            <!-- Luftfeuchtigkeit -->
            <div class="panel">
                <div class="panel-header">
                    <div class="panel-title">üíß Luftfeuchtigkeit</div>
                </div>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-label">Aktuell</div>
                        <div class="stat-value" id="current-hum">--%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">√ò</div>
                        <div class="stat-value" id="avg-hum">--%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Min</div>
                        <div class="stat-value" id="min-hum">--%</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Max</div>
                        <div class="stat-value" id="max-hum">--%</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="humChart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Fehlermeldungen -->
        <div class="error-panel">
            <div class="panel-header">
                <div class="panel-title">‚ö†Ô∏è Fehlermeldungen</div>
            </div>
            <div class="error-list" id="error-list">
                <div class="no-errors">‚úì Keine Fehler</div>
            </div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            Made by <span class="footer-name">David Omowanile</span>
        </div>
    </div>
    
    <!-- Temperatur Modal -->
    <div class="modal-overlay" id="tempModal">
        <div class="modal">
            <div class="modal-title">Wunsch-Temperatur</div>
            <div class="modal-display" id="tempDisplay">25.0</div>
            <div class="numpad">
                <button class="numpad-btn" onclick="tempInput('7')">7</button>
                <button class="numpad-btn" onclick="tempInput('8')">8</button>
                <button class="numpad-btn" onclick="tempInput('9')">9</button>
                <button class="numpad-btn" onclick="tempInput('4')">4</button>
                <button class="numpad-btn" onclick="tempInput('5')">5</button>
                <button class="numpad-btn" onclick="tempInput('6')">6</button>
                <button class="numpad-btn" onclick="tempInput('1')">1</button>
                <button class="numpad-btn" onclick="tempInput('2')">2</button>
                <button class="numpad-btn" onclick="tempInput('3')">3</button>
                <button class="numpad-btn" onclick="tempInput('.')">.</button>
                <button class="numpad-btn" onclick="tempInput('0')">0</button>
                <button class="numpad-btn" onclick="tempBackspace()">‚å´</button>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeTempEditor()">Abbrechen</button>
                <button class="modal-btn confirm" onclick="confirmTemp()">Best√§tigen</button>
            </div>
        </div>
    </div>
    
    <!-- Filter-Zeit Modal -->
    <div class="modal-overlay" id="timeModal">
        <div class="modal">
            <div class="modal-title">Filter-Schwellwert</div>
            <div class="modal-display" id="timeDisplay">00:00:00</div>
            <div class="numpad">
                <button class="numpad-btn" onclick="timeInput('7')">7</button>
                <button class="numpad-btn" onclick="timeInput('8')">8</button>
                <button class="numpad-btn" onclick="timeInput('9')">9</button>
                <button class="numpad-btn" onclick="timeInput('4')">4</button>
                <button class="numpad-btn" onclick="timeInput('5')">5</button>
                <button class="numpad-btn" onclick="timeInput('6')">6</button>
                <button class="numpad-btn" onclick="timeInput('1')">1</button>
                <button class="numpad-btn" onclick="timeInput('2')">2</button>
                <button class="numpad-btn" onclick="timeInput('3')">3</button>
                <button class="numpad-btn" onclick="timeInput('0')" style="grid-column: span 2">0</button>
                <button class="numpad-btn" onclick="timeBackspace()">‚å´</button>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeTimeEditor()">Abbrechen</button>
                <button class="modal-btn confirm" onclick="confirmTime()">Best√§tigen</button>
            </div>
        </div>
    </div>
    
    <!-- ACS TOT-Wert Modal -->
    <div class="modal-overlay" id="acsModal">
        <div class="modal">
            <div class="modal-title">L√ºfter TOT-Wert</div>
            <div class="modal-display" id="acsDisplay">520</div>
            <div style="color: var(--text-secondary); font-size: 0.85rem; text-align: center; margin-bottom: 15px;">
                Werte ‚â§ dieser Schwelle = kein Strom
            </div>
            <div class="numpad">
                <button class="numpad-btn" onclick="acsInput('7')">7</button>
                <button class="numpad-btn" onclick="acsInput('8')">8</button>
                <button class="numpad-btn" onclick="acsInput('9')">9</button>
                <button class="numpad-btn" onclick="acsInput('4')">4</button>
                <button class="numpad-btn" onclick="acsInput('5')">5</button>
                <button class="numpad-btn" onclick="acsInput('6')">6</button>
                <button class="numpad-btn" onclick="acsInput('1')">1</button>
                <button class="numpad-btn" onclick="acsInput('2')">2</button>
                <button class="numpad-btn" onclick="acsInput('3')">3</button>
                <button class="numpad-btn" onclick="acsInput('0')" style="grid-column: span 2">0</button>
                <button class="numpad-btn" onclick="acsBackspace()">‚å´</button>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" onclick="closeAcsEditor()">Abbrechen</button>
                <button class="modal-btn confirm" onclick="confirmAcs()">Best√§tigen</button>
            </div>
        </div>
    </div>
    
    <script>
        // ========== GLOBALE VARIABLEN ==========
        let serialPort = null;
        let reader = null;
        let statusData = {};
        let tempChart = null;
        let humChart = null;
        let tempValue = '25.0';
        let timeValue = '00:00:00';
        let acsValue = '520';
        let errorList = [];
        
        // ========== SERIAL CONNECTION ==========
        async function connectSerial() {
            try {
                serialPort = await navigator.serial.requestPort();
                await serialPort.open({ baudRate: 9600 });
                
                document.getElementById('connectionStatus').textContent = '‚óè Verbunden';
                document.getElementById('connectionBtn').classList.remove('disconnected');
                
                const textDecoder = new TextDecoderStream();
                serialPort.readable.pipeTo(textDecoder.writable);
                reader = textDecoder.readable.getReader();
                
                readSerialData();
                
                // Datum/Uhrzeit setzen
                const now = new Date();
                const dateTimeCmd = 'U' + 
                    now.getFullYear() +
                    String(now.getMonth() + 1).padStart(2, '0') +
                    String(now.getDate()).padStart(2, '0') +
                    String(now.getHours()).padStart(2, '0') +
                    String(now.getMinutes()).padStart(2, '0') +
                    String(now.getSeconds()).padStart(2, '0');
                
                await sendCommand(dateTimeCmd);
                
                // Initial Status holen
                setTimeout(() => {
                    sendCommand('H');
                    sendCommand('D');
                    sendCommand('E');
                    sendCommand('F');
                }, 1000);
                
            } catch (error) {
                console.error('Verbindungsfehler:', error);
            }
        }
        
        async function readSerialData() {
            let buffer = '';
            let inStatus = false;
            let inCSV = false;
            let inErrors = false;
            let csvData = [];
            let csvType = '';
            let bufferIndex = 0;
            
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    
                    buffer += value;
                    const lines = buffer.split('\n');
                    buffer = lines.pop();
                    
                    for (const line of lines) {
                        const trimmed = line.trim();
                        if (trimmed.length === 0) continue;
                        
                        console.log('Arduino:', trimmed);
                        
                        if (trimmed === 'STATUS_START') {
                            statusData = {};
                            inStatus = true;
                        } else if (trimmed === 'STATUS_END') {
                            updateDisplay(statusData);
                            inStatus = false;
                        } else if (inStatus && trimmed.includes(':')) {
                            const [key, value] = trimmed.split(':');
                            statusData[key] = value;
                        } else if (trimmed === 'CSV_START' || trimmed === 'TEMP_CSV_START') {
                            inCSV = true;
                            csvData = [];
                            csvType = trimmed === 'CSV_START' ? 'humidity' : 'temperature';
                        } else if (trimmed === 'CSV_END' || trimmed === 'TEMP_CSV_END') {
                            updateChart(csvType, csvData, bufferIndex);
                            inCSV = false;
                        } else if (inCSV && trimmed.startsWith('INDEX:')) {
                            bufferIndex = parseInt(trimmed.split(':')[1]);
                        } else if (inCSV && trimmed.includes(',')) {
                            const parts = trimmed.split(',');
                            csvData.push(parseFloat(parts[1]));
                        } else if (trimmed === 'ERRORS_START') {
                            errorList = [];
                            inErrors = true;
                        } else if (trimmed === 'ERRORS_END') {
                            updateErrorList();
                            inErrors = false;
                        } else if (inErrors && trimmed.includes('|')) {
                            const parts = trimmed.split('|');
                            if (parts.length === 5) {
                                errorList.push({
                                    index: parseInt(parts[0]),
                                    code: parts[1],
                                    message: parts[2],
                                    datetime: parts[3],  // Bereits formatiert: YYYY-MM-DD HH:MM:SS
                                    status: parts[4]
                                });
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Lesefehler:', error);
            }
        }
        
        async function sendCommand(cmd) {
            if (!serialPort) return;
            
            try {
                const writer = serialPort.writable.getWriter();
                await writer.write(new TextEncoder().encode(cmd + '\n'));
                writer.releaseLock();
                console.log('Gesendet:', cmd);
            } catch (error) {
                console.error('Sendefehler:', error);
            }
        }
        
        // ========== DISPLAY UPDATE ==========
        function updateDisplay(data) {
            console.log('Update:', data);
            
            // Temperatur
            if (data.TEMP) {
                document.getElementById('current-temp').textContent = parseFloat(data.TEMP).toFixed(1) + '¬∞C';
            }
            
            // Wunsch-Temp
            if (data.TARGET && !document.getElementById('tempModal').classList.contains('active')) {
                document.getElementById('target-temp').textContent = parseFloat(data.TARGET).toFixed(1) + '¬∞C';
            }
            
            // Luftfeuchtigkeit
            if (data.HUM) {
                document.getElementById('current-hum').textContent = parseFloat(data.HUM).toFixed(1) + '%';
            }
            
            // ACS712
            if (data.ACS712) {
                document.getElementById('acs-value').textContent = data.ACS712;
            }
            
            // ACS TOT-Wert
            if (data.ACS_DEAD && !document.getElementById('acsModal').classList.contains('active')) {
                document.getElementById('acs-dead').textContent = data.ACS_DEAD;
            }
            
            // LEDs
            updateLED('led1', data.RELAY1 === '1', false);
            document.getElementById('fan-status').textContent = data.RELAY1 === '1' ? 'AN' : 'AUS';
            
            updateLED('led2', data.RELAY2 === '1', false);
            
            // Filter-Countdown
            if (data.THRESHOLD && data.OVERHEAT && !document.getElementById('timeModal').classList.contains('active')) {
                const threshold = parseInt(data.THRESHOLD);
                const overheat = parseInt(data.OVERHEAT);
                const remaining = threshold - overheat;
                
                if (remaining > 0) {
                    const hours = Math.floor(remaining / 3600);
                    const minutes = Math.floor((remaining % 3600) / 60);
                    const seconds = remaining % 60;
                    document.getElementById('filter-countdown').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                } else {
                    document.getElementById('filter-countdown').textContent = '00:00:00';
                }
            }
            
            // Temp-Status
            const tempHigh = data.TEMP && data.TARGET && parseFloat(data.TEMP) >= parseFloat(data.TARGET);
            updateLED('led3', data.RELAY3 === '1', tempHigh);
            document.getElementById('temp-status').textContent = tempHigh ? 'HOCH' : 'OK';
            
            // Defekt
            const fanDefectStored = data.FAN_DEFECT_STORED === '1';
            const ledOn = data.LED === '1';
            
            // Wenn gespeichert aber L√ºfter l√§uft wieder ‚Üí Blinken
            if (fanDefectStored && !ledOn) {
                updateLED('led4', true, true);  // Rot blinkend
                document.getElementById('defect-status').textContent = 'WIEDERHERGESTELLT';
                document.getElementById('clear-defect-btn').style.display = 'block';
            } else if (ledOn) {
                updateLED('led4', true, false);  // Rot permanent
                document.getElementById('defect-status').textContent = 'DEFEKT';
                document.getElementById('clear-defect-btn').style.display = 'block';
            } else {
                updateLED('led4', false, false);  // Aus
                document.getElementById('defect-status').textContent = 'OK';
                document.getElementById('clear-defect-btn').style.display = 'none';
            }
        }
        
        function updateErrorList() {
            const errorListEl = document.getElementById('error-list');
            
            if (errorList.length === 0) {
                errorListEl.innerHTML = '<div class="no-errors">‚úì Keine Fehler</div>';
                return;
            }
            
            errorListEl.innerHTML = errorList.map(err => {
                // Zeitstempel ist bereits formatiert: YYYY-MM-DD HH:MM:SS
                const errorTime = new Date(err.datetime.replace(' ', 'T'));
                const now = new Date();
                const diffMs = now - errorTime;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const diffDays = Math.floor(diffHours / 24);
                
                let timeAgo = '';
                if (diffDays > 0) {
                    timeAgo = `vor ${diffDays}d ${diffHours % 24}h`;
                } else if (diffHours > 0) {
                    timeAgo = `vor ${diffHours}h ${diffMins % 60}min`;
                } else if (diffMins > 0) {
                    timeAgo = `vor ${diffMins}min`;
                } else {
                    timeAgo = 'gerade eben';
                }
                
                return `
                    <div class="error-item">
                        <span class="error-code">${err.code}</span>
                        <span class="error-message">${err.message}</span>
                        <span class="error-time">${err.datetime}<br><small style="color: var(--pink);">${timeAgo}</small></span>
                        <button class="error-delete" onclick="deleteError(${err.index})">üóëÔ∏è</button>
                    </div>
                `;
            }).join('');
        }
        
        async function deleteError(index) {
            await sendCommand('X' + index);
            setTimeout(() => sendCommand('F'), 1000);
        }
        
        function updateLED(id, isOn, shouldBlink) {
            const led = document.getElementById(id);
            
            if (isOn) {
                led.classList.remove('led-off');
                if (shouldBlink) {
                    led.classList.add('led-blink');
                } else {
                    led.classList.remove('led-blink');
                }
            } else {
                led.classList.add('led-off');
                led.classList.remove('led-blink');
            }
        }
        
        // ========== CHARTS ==========
        function initCharts() {
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: { 
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: { color: '#B0B3B8' }
                    },
                    y: { 
                        grid: { color: 'rgba(255,255,255,0.1)' },
                        ticks: { color: '#B0B3B8' }
                    }
                }
            };
            
            tempChart = new Chart(document.getElementById('tempChart'), {
                type: 'line',
                data: {
                    labels: Array(60).fill(''),
                    datasets: [{
                        data: Array(60).fill(0),
                        borderColor: '#FF006E',
                        backgroundColor: 'rgba(255, 0, 110, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { 
                            ...commonOptions.scales.y,
                            min: 0,
                            max: 50
                        }
                    }
                }
            });
            
            humChart = new Chart(document.getElementById('humChart'), {
                type: 'line',
                data: {
                    labels: Array(60).fill(''),
                    datasets: [{
                        data: Array(60).fill(0),
                        borderColor: '#FF006E',
                        backgroundColor: 'rgba(255, 0, 110, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: { 
                            ...commonOptions.scales.y,
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }
        
        function updateChart(type, data, currentIndex) {
            const reorderedData = [];
            for (let i = 0; i < data.length; i++) {
                const idx = (currentIndex + i) % data.length;
                reorderedData.push(data[idx]);
            }
            
            const chart = type === 'temperature' ? tempChart : humChart;
            chart.data.datasets[0].data = reorderedData;
            chart.update();
            
            // Stats
            const valid = reorderedData.filter(v => v > 0);
            if (valid.length > 0) {
                const min = Math.min(...valid);
                const max = Math.max(...valid);
                const avg = valid.reduce((a, b) => a + b, 0) / valid.length;
                
                if (type === 'temperature') {
                    document.getElementById('min-temp').textContent = min.toFixed(1) + '¬∞C';
                    document.getElementById('avg-temp').textContent = avg.toFixed(1) + '¬∞C';
                } else {
                    document.getElementById('avg-hum').textContent = avg.toFixed(1) + '%';
                    document.getElementById('min-hum').textContent = min.toFixed(1) + '%';
                    document.getElementById('max-hum').textContent = max.toFixed(1) + '%';
                }
            }
        }
        
        // ========== TEMPERATUR EDITOR ==========
        function openTempEditor() {
            tempValue = '0';
            document.getElementById('tempDisplay').textContent = tempValue;
            document.getElementById('tempModal').classList.add('active');
        }
        
        function closeTempEditor() {
            document.getElementById('tempModal').classList.remove('active');
        }
        
        function tempInput(value) {
            if (value === '.') {
                if (!tempValue.includes('.')) {
                    tempValue += '.';
                }
            } else {
                if (tempValue === '0') {
                    tempValue = value;
                } else {
                    tempValue += value;
                }
            }
            document.getElementById('tempDisplay').textContent = tempValue;
        }
        
        function tempBackspace() {
            if (tempValue.length > 1) {
                tempValue = tempValue.slice(0, -1);
            } else {
                tempValue = '0';
            }
            document.getElementById('tempDisplay').textContent = tempValue;
        }
        
        async function confirmTemp() {
            const temp = parseFloat(tempValue);
            if (!isNaN(temp) && temp >= 0 && temp <= 50) {
                document.getElementById('target-temp').textContent = temp.toFixed(1) + '¬∞C';
                closeTempEditor();
                await sendCommand('T' + temp);
                setTimeout(() => sendCommand('H'), 2000);
            } else {
                alert('Ung√ºltige Temperatur (0-50¬∞C)');
            }
        }
        
        // ========== ZEIT EDITOR ==========
        function openTimeEditor() {
            timeValue = '000000';
            document.getElementById('timeDisplay').textContent = '00:00:00';
            document.getElementById('timeModal').classList.add('active');
        }
        
        function closeTimeEditor() {
            document.getElementById('timeModal').classList.remove('active');
        }
        
        function timeInput(value) {
            timeValue = timeValue.substring(1) + value;
            const hours = timeValue.substring(0, 2);
            const minutes = timeValue.substring(2, 4);
            const seconds = timeValue.substring(4, 6);
            document.getElementById('timeDisplay').textContent = `${hours}:${minutes}:${seconds}`;
        }
        
        function timeBackspace() {
            timeValue = '0' + timeValue.substring(0, 5);
            const hours = timeValue.substring(0, 2);
            const minutes = timeValue.substring(2, 4);
            const seconds = timeValue.substring(4, 6);
            document.getElementById('timeDisplay').textContent = `${hours}:${minutes}:${seconds}`;
        }
        
        async function confirmTime() {
            const hours = parseInt(timeValue.substring(0, 2));
            const minutes = parseInt(timeValue.substring(2, 4));
            const seconds = parseInt(timeValue.substring(4, 6));
            
            const totalSeconds = hours * 3600 + minutes * 60 + seconds;
            
            if (totalSeconds > 0 && totalSeconds <= 86400) {
                closeTimeEditor();
                await sendCommand('S' + totalSeconds);
                setTimeout(() => sendCommand('H'), 2000);
            } else {
                alert('Ung√ºltige Zeit (max 24h)');
            }
        }
        
        // ========== FILTER RESET ==========
        async function resetFilter() {
            if (confirm('Filter-Zeit zur√ºcksetzen?')) {
                await sendCommand('R');
                setTimeout(() => sendCommand('H'), 1000);
            }
        }
        
        // ========== ACS TOT-WERT EDITOR ==========
        function openAcsEditor() {
            acsValue = '0';
            document.getElementById('acsDisplay').textContent = acsValue;
            document.getElementById('acsModal').classList.add('active');
        }
        
        function closeAcsEditor() {
            document.getElementById('acsModal').classList.remove('active');
        }
        
        function acsInput(value) {
            if (acsValue === '0') {
                acsValue = value;
            } else if (acsValue.length < 4) {
                acsValue += value;
            }
            document.getElementById('acsDisplay').textContent = acsValue;
        }
        
        function acsBackspace() {
            if (acsValue.length > 1) {
                acsValue = acsValue.slice(0, -1);
            } else {
                acsValue = '0';
            }
            document.getElementById('acsDisplay').textContent = acsValue;
        }
        
        async function confirmAcs() {
            const val = parseInt(acsValue);
            if (!isNaN(val) && val >= 0 && val <= 1023) {
                document.getElementById('acs-dead').textContent = val;
                closeAcsEditor();
                await sendCommand('A' + val);
                setTimeout(() => sendCommand('H'), 2000);
            } else {
                alert('Ung√ºltiger Wert (0-1023)');
            }
        }
        
        async function resetAcsDead() {
            if (confirm('ACS TOT-Wert auf 520 zur√ºcksetzen?')) {
                await sendCommand('A520');
                setTimeout(() => sendCommand('H'), 1000);
            }
        }
        
        async function clearFanDefect() {
            if (confirm('L√ºfter-Defekt zur√ºcksetzen?')) {
                await sendCommand('C');
                setTimeout(() => {
                    sendCommand('H');
                    sendCommand('F');
                }, 1000);
            }
        }
        
        // ========== AUTO-UPDATE ==========
        setInterval(async () => {
            if (serialPort) {
                await sendCommand('H');
                await sendCommand('D');
                await sendCommand('E');
                await sendCommand('F');
            }
        }, 5000); // Alle 5 Sekunden
        
        // ========== INIT ==========
        document.addEventListener('DOMContentLoaded', () => {
            initCharts();
        });
        
        // ESC zum Schlie√üen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeTempEditor();
                closeTimeEditor();
                closeAcsEditor();
            }
        });
    </script>
</body>
</html>
